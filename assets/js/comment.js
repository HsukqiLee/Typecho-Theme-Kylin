$(document).ready(function(){function serializeFormData(form){return $(form).serialize().replace(/%20/g,'+');}function postComment(url,data,successCallback,errorCallback){$.ajax({type:'POST',url:url,data:data,beforeSend:function(xhr){xhr.setRequestHeader('X-Requested-With','XMLHttpRequest');},success:function(response){successCallback(response);},error:function(xhr,status,error){errorCallback(xhr,status,error);}});}function showToast(icon,title,text,timer){Toast.fire({icon:icon,title:title,text:text||'',timer:timer||3000,});}$('#comment-form').submit(function(e){e.preventDefault();var $form=$(this);var url=$form.attr('action');var formData=serializeFormData($form);postComment(url,formData,function(response){handleCommentInsertion(response);resetTurnstile();},function(xhr,status,error){showToast('error',commentErrorTitle,commentFailedToSubmitMessage);resetTurnstile();});});function getCommentParent(){var $input=$('#comment-parent[name="parent"]');if($input.length>0){var value=$input.val();var number=value.match(/\d+/)[0];return number;}return false;}function getNewestCommentHTML(response){var regex=/<div class="media comment">[\s\S]*?id="comment-(\d+)"[\s\S]*?<\/div>\s*<\/div>\s*<\/div>/g;var matches;var maxId=-1;var newestCommentHTML='';while((matches=regex.exec(response))!==null){var commentId=parseInt(matches[1],10);if(commentId>maxId){maxId=commentId;newestCommentHTML=matches[0];}}return newestCommentHTML;}function getCommentNum(response){var $parsedHTML=$(response);var commentText=null;$parsedHTML.find('.tk-comments-count span').each(function(){commentText=$(this).text();return false;});return commentText;}function getCommentChildren(responseHTML){var response=new DOMParser().parseFromString(responseHTML,'text/html');var comments=Array.prototype.filter.call(response.querySelectorAll('[id^="comment-"]'),function(comment){return /^comment-\d+$/.test(comment.id);});var maxId=Math.max.apply(Math,comments.map(function(comment){return parseInt(comment.id.split('-')[1],10);}));var maxCommentElement=response.querySelector('#comment-'+maxId);if(!maxCommentElement)return false;return maxCommentElement.closest('.media.comment');}function handleCommentInsertion(responseHTML){var commentParent=getCommentParent();var newCommentNum=getCommentNum(responseHTML);if(newCommentNum){$('.tk-comments-count > span').text(newCommentNum);}if(commentParent){var commentChildren=getCommentChildren(responseHTML);if(commentChildren){$('div#comment-'+commentParent+' > div.content').after('<div class="comment-children">'+commentChildren.outerHTML+'</div>');TypechoComment.cancelReply();resetCommentForm();showToast('success',commentSuccessTitle,commentSuccessMessage);}else{showToast('error',commentErrorTitle,commentFailedToFetchMessage);}}else{var newCommentHTML=getNewestCommentHTML(responseHTML);if(newCommentHTML){$('.comment-list').prepend(newCommentHTML);resetCommentForm();showToast('success',commentSuccessTitle,commentSuccessMessage);}else{showToast('error',commentErrorTitle,commentFailedToFetchMessage);}}}function resetCommentForm(){$('#comment-form').find('textarea[name="text"]').val('');$('div.comment img.lazyload').lazyload();if(typeof moment==='function'){$('.comment time').each(function(){var datetime=$(this).attr('datetime');$(this).text(moment(datetime).fromNow());});}}function resetTurnstile(){if(typeof window.onloadTurnstileCallback==='function'){window.onloadTurnstileCallback();}}});
